---
title: "Undergraduate Research"
author: "Donald Dinerman"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Using Data to Support Students

## Project Description

The Statistics & Data Science Advising team wants to use data to better support students. Using anonymized course performance data, your team will assess and seek to answer numerous questions. The dataset will include course final grades for courses Statistics & Data Science graduates have taken over the past several (approximately 6) years. Data will include a student identifier, courses taken, final grades in courses, the class level of the student when they took the course, student major when they took the course, and the semester the courses were taken. 

## Read Data

```{r, include=F}
#Load libraries

library(dplyr)
```

```{r}
stat_df = read.csv("stats_data.csv")
head(stat_df,5)
```

Questions:

1. For first enrolled, I assume F and S are Fall and Spring. But what is M? M is 1st summer term

2. For major, what is H00? H00 means undeclared

3. What does class_id signify? (e.g., 1 = freshman, ..., 4 = senior)

4. What is M and N for semester? first and second term in summer

5. There are instances where first enroll happens after the course semester. Does this mean the student enrolled after they took the course, what's up with that? can designate first semester of courses as first enroll variable

6. How to designate pre-reqs? label as go, from forward to back(e.g., took 401 lets see when and how you did in 226)

7. How to identify electives and core classes? course catalogs

## Prep Data

```{r}
#create var designating semester and relative year (e.g., Freshman Fall 2020, Junior Spring 2019)
#use regex to sparse through first_enrolled and semester
#not as simple as subtracting (how to id transfers)

char_remover = function(x){gsub("[^0-9.-]", "", x) %>% as.numeric()}

sem = char_remover(stat_df$semester) - char_remover(stat_df$first_enrolled)

#instances where first enroll date > semester date (weird, need explanation) (119 students) 
stat_df[which(sem < 0),] %>% head(5)
```

```{r}
#filter out non-majors (H00: undeclared) if the last semester is H00
#e.g., if STA last semester, change H00 to STA

h00_students = stat_df %>%
  group_by(student) %>%
  summarise(major) %>%
  summarise_all(last) %>% #takes last semester student is recorded
  filter(major == "H00") %>%
  pull(1)

`%!in%` = Negate(`%in%`) #create %!in% operator

declared_stat_df = stat_df %>%
  filter(student %!in% h00_students)
```

**Check with Pef**
```{r}
#Some students switched majors midway (interesting)
#using merge, assign students who switched majors midway to the major they have in their last semester
#eg., STA to ECOSTA is now a ECOSTA for all the semesters (check with pef)

#major in student's last semester
declared_students = stat_df %>%
  group_by(student) %>%
  summarise(major) %>%
  summarise_all(last) %>% #takes last semester student is recorded
  filter(major != "H00")

#Merge df (its like left join)

drop.cols = c("major.x", "major.y")

merged_df = left_join(declared_stat_df, declared_students, "student") %>% #keeps all x rows, matches y rows by student
  mutate(major = major.y, .before = first_enrolled) %>% #major.y are the fin semester majors
  select(-drop.cols) #removes duplicate major.y and major.x from previous df
  
head(merged_df, 5)
```


```{r}
#EDA on classes are going to have to be based on some group (e.g., second year stats courses, 36-3## courses, econ electives, etc.)
table(declared_stat_df$course, declared_stat_df$grade) %>% head()

unique(declared_stat_df$course) %>% length() #number of classes
```

```{r}
#make proportion table for courses
#e.g., 0.001 kids take 21-366

n_students = merged_df$student %>% unique() %>% length()

prop_tab = (table(merged_df$course) / n_students) %>% round(4) #round by 4 so that percentage is rounded by 2

percentage_course_df = as.data.frame(prop_tab * 100) %>% arrange(-Freq)

colnames(percentage_course_df) = c("Course", "% of Students")

head(percentage_course_df, 5)
```

```{r}
#group prop courses by major
hold = declared_students %>% #to get students per major
  group_by(major) %>%
  summarise(count = n())

test = merged_df %>% #to get students in course by major
  group_by(major) %>%
  count(course, name = "n_course")

percentage_course_by_major = left_join(test, hold, "major") %>%
  mutate(prop = round((n_course/count)*100, 2)) %>%
  group_by(major) %>%
  slice_max(n = 3, order_by = prop, with_ties = F) %>%
  arrange(major, -prop)

head(percentage_course_by_major, 5)
```

```{r}
#remove grad classes
#(1) keep 10-xxx, (2) remove xx-600 >
#######Issue: Master courses and other omitted courses still feed into units carried, GPA

#identify xx-600 >
index_1 = grepl("^..[6-9]", merged_df$course)

df_1 = merged_df[index_1,]

#identify 10-xxx
index_2 = grepl("^[1][0]...", df_1$course)

df_2 = df_1[!index_2,] #get courses that are don't start with 10 but end with 600 or greater

undergrad_df = merged_df[merged_df$course %!in% df_2$course,]

head(undergrad_df, 5)
```

```{r}
#Calculate GPA
#By semester (updating each semester based on previous semester and total QPA)
#Quality Points = units * grade
#QPA = sum(QP)/sum(units)
#(A = 4, B = 3, C = 2, D = 1, R = 0, P/N/O/W doesn't count towards GPA)

#case_when is type-strict meaning you need to return values of same type
#classify P/N/O/W as 100 and then remove rows where number_grade == 100
undergrad_df$number_grade = case_when(
  undergrad_df$grade == "A" ~ 4,
  undergrad_df$grade == "B" ~ 3,
  undergrad_df$grade == "C" ~ 2,
  undergrad_df$grade == "D" ~ 1,
  undergrad_df$grade == "R" ~ 0,
  TRUE ~ 100
  )

basic_grade_df = undergrad_df[undergrad_df$number_grade != 100,]

basic_grade_df$quality_points = basic_grade_df$units*basic_grade_df$number_grade

basic_grade_df

#QPA by semester (how to create an updating QPA that is weighed by previous semesters)
basic_grade_df %>% 
  group_by(student, semester) %>%
  summarise(n_courses = n(),
            QP_sum = sum(quality_points), 
            unit_sum = sum(units), 
            QPA = round(QP_sum/unit_sum,2)
            )

#Then left_join that dataframe with the main one by student and semester (think primary and foreign key)
```

## EDA

```{r}
#popular electives by major
```

```{r}
#proportion retake classes
#top 10 courses that are retaken
#how kids do their first time vs their second time
```

```{r}
#contingency tables on performance with class x and class y
```

```{r}
#y1 and y2 are classes
#x is grades
#facetted by whether they took this pre-req class
```























